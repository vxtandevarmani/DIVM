
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/mman.h>

int main() {
    // Example shellcode (just returns 42 on ARM64)
    unsigned char shellcode[] = "\x21\x0c\x8e\xd2\x01\x0e\xa0\xf2\xe1\x83\x1f\xf8\x61\xac\x8e\xd2\x81\x2d\xac\xf2\x81\xee\xcd\xf2\x41\xce\xe5\xf2\xe1\x03\x1f\xf8\x21\xed\x8d\xd2\xc1\x6d\xae\xf2\xe1\x65\xc8\xf2\x21\x8c\xed\xf2\xe1\x83\x1e\xf8\x21\x08\x8e\xd2\x01\x8e\xad\xf2\x21\x6d\xcc\xf2\x21\x8c\xee\xf2\xe1\x03\x1e\xf8\xe1\x65\x8a\xd2\x21\x6f\xae\xf2\x81\xae\xcc\xf2\xa1\xed\xe5\xf2\xe1\x83\x1d\xf8\xe1\xe5\x8d\xd2\x01\xae\xac\xf2\xc1\x0d\xc0\xf2\xe1\x03\x1d\xf8\xe1\xa5\x8e\xd2\x61\x4e\xae\xf2\xe1\x45\xcc\xf2\x21\xcd\xed\xf2\xe1\x83\x1c\xf8\xff\x03\x1c\xf8\x01\x05\x80\xd2\xe1\x63\x21\xcb\xe1\x83\x1b\xf8\x01\x07\x80\xd2\xe1\x63\x21\xcb\xe1\x03\x1b\xf8\xe0\x03\x01\xaa\xe1\x43\x01\xd1\xe2\x03\x1f\xaa\x70\x07\x80\xd2\xe1\x66\x02\xd4";

    size_t size = sizeof(shellcode);

    // Allocate memory with malloc
    void *mem = malloc(size);
    if (!mem) { perror("malloc"); return 1; }

    memcpy(mem, shellcode, size);

    // Align to page boundary
    size_t pagesize = sysconf(_SC_PAGESIZE);
    void *page_start = (void *)((uintptr_t)mem & ~(pagesize - 1));

    // Change memory protection to RX (read + execute)
    if (mprotect(page_start, pagesize, PROT_READ | PROT_EXEC) == -1) {
        perror("mprotect");
        return 1;
    }

    // Call the shellcode
    int (*func)() = mem;
    int result = func();
    printf("Shellcode returned: %d\n", result);

    return 0;
}
